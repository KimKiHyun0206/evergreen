name: Setup Daily Log Entry

on:
  schedule:
    - cron: '17 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  add-daily-line:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Insert Daily Log and Update README
        run: |
          # 1. í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ë° ì›” êµ¬í•˜ê¸°
          MONTH_PATH=$(date -u -d "+9 hours" "+%Y-%m")
          TODAY=$(date -u -d "+9 hours" "+%Y-%m-%d (%a)")
          FILENAME="logs/daily-log-${MONTH_PATH}.md"
          
          # 2. logs í´ë” ìƒì„±
          mkdir -p logs
          
          # 3. ì›”ë³„ ë¡œê·¸ íŒŒì¼ ìƒì„± ë° ë‚´ìš© ì¶”ê°€ (ì•„ë˜ë¡œ ìŒ“ê¸°)
          if [ ! -f "$FILENAME" ]; then
            echo "# ğŸ“… $MONTH_PATH Learning Log" > "$FILENAME"
            echo -e "ì´ë²ˆ ë‹¬ì˜ ì„±ì¥ì„ ê¸°ë¡í•©ë‹ˆë‹¤. ğŸŒ±\n" >> "$FILENAME"
            echo "---" >> "$FILENAME"
          fi

          echo -e "\n> ### ğŸŒ± **$TODAY**" >> "$FILENAME"
          echo "- " >> "$FILENAME"
          echo -e "\n---" >> "$FILENAME"

          # 4. README.mdì˜ 'ì´ë²ˆ ë‹¬ ë¡œê·¸' ë§í¬ë¥¼ í˜„ì¬ ì›”ë¡œ ìë™ ì—…ë°ì´íŠ¸
          # [ğŸ“… ì´ë²ˆ ë‹¬ ë¡œê·¸ í™•ì¸í•˜ê¸°](./logs/daily-log-XXXX-XX.md) í˜•ì‹ì„ ì°¾ì•„ êµì²´í•©ë‹ˆë‹¤.
          sed -i "s|\[ğŸ“… ì´ë²ˆ ë‹¬ ë¡œê·¸ í™•ì¸í•˜ê¸°\](.*)|\[ğŸ“… ì´ë²ˆ ë‹¬ ë¡œê·¸ í™•ì¸í•˜ê¸°\](./${FILENAME})|g" README.md

      - name: Commit and Push
        run: |
          git config --global user.name "Duskafka"
          git config --global user.email "rlarlgus0206@naver.com"
          
          # logs í´ë”ì™€ README.mdì˜ ë³€ê²½ì‚¬í•­ì„ ëª¨ë‘ í¬í•¨
          git add logs/ README.md
          
          TODAY=$(date -u -d "+9 hours" "+%Y-%m-%d (%a)")
          git commit -m "chore: update daily log and README link for $TODAY" || echo "No changes to commit"
          git push
